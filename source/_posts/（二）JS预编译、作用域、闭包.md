---
title: （二）JS预编译、作用域、闭包
date: 2019-11-01 20:04:32
tags: JavaScript
---
首先聊聊JS的预编译。

JavaScript是解释性语言，也就是说解释一行执行一行。
执行JS语句分三步：
1.语法分析。
2.预编译。
3.解释执行。

什么是预编译呢？
预编译就是在函数执行的前一刻，将函数声明整体提升，将变量的声明提升。

预编译四部曲：
1.创建AO对象（Activation Object执行期上下文）。
2.找形参和变量声明，将变量和形参名作为AO的属性名，值为undefined。
3.将实参值和形参统一。
4.在函数体里面找函数声明，值赋予函数体。

什么是AO对象呢？
AO对象。意思是当函数执行时，会创建一个称为执行期上下文的每部对象。一个执行期上下文定义了一个函数执行时的环境，函数每次执行时对应的执行期上下文都是独一无二的，所以多次调用一个函数时会导致创建多个执行期上下文，当函数执行完毕，它所创建的执行期上下文被销毁。


然后再来说说作用域。

所谓作用域，指的就是scope。
每个JavaScript函数都是一个对象，对象中有些属性我们可以访问，有些不可以。这些我们不可以访问的属性，仅供JavaScript引擎存取。scope就是其中之一。scope，存储了运行期上下文的集合，也就是作用域链。
作用域链：scope中存储了运行期上下文的集合，这个集合是呈链式连接的，我们把这种链式连接叫做作用域链。

简单的讲，我们在定义一个函数时，函数内部是有一个内部属性scope的，scope中首先先放一个go（Global Object全局上下文）的引用，将它父类的属性拿过来用，此时函数还没有被执行。当执行这个函数时，创建一个自己的ao（Activation Object执行期上下文），把ao放在scope的第一位，go就到了第二位，这样scope内部就形成了一个作用域链。这样，我们在查找变量的时候，在哪个函数中查找变量，我们就从哪个函数的作用域链的顶端，依次向下查找。


最后是闭包。

关于闭包，这里只是大概的讲讲，因为今后会有大量的闭包应用，到时在根据实际的应用具体分析。

什么是闭包？
闭包就是能够读取其他函数内部变量的函数。

闭包是怎么形成的？
当内部函数被保存到外部的时候，就会产生闭包。

举个例子：
```
    function a(){

        function b(){
            document.write(aaa);
        }

        var aaa = 123;
        return b;
    }

    var demo = a();
    demo();
```
这个例子意思是，创建一个方法a，方法a中有一个方法b。方法a中定义了一个变量aaa，然后方法a的返回值是方法b，也就是说把方法b保存了出来。
aaa变量是存在于a方法的ao中的，当a方法执行完毕时，会销毁与自己ao的联系，但是，由于b方法被保存出来，b方法与a方法的ao并没有断了联系。
所以最后执行demo的时候，结果是123。
使用b方法读取到了a方法的内部变量，这就叫闭包。

闭包的危害：
闭包会导致原有的作用域链不释放，造成内存泄漏。

闭包的作用：
1.实现公有变量。
2.可以用做缓存（存储结构）。
3.可以实现封装，属性私有化。
4.模块化开发，防止污染全局变量。


最后写一个小例子：
```
    function test(){

        var arr = [];
        for(var i = 0; i < 10 ; i++){
            arr[i] = function (){
                document.write(i + "  ");
            }
        }
        return arr;
    }
    var myArr = test();

    for(var j = 0 ; j < 10 ; j++){
        myArr[j]();
    }
```
问输出的结果是什么？

答案是输出十个数字"10"。

为什么是十个数字"10呢"，这也是闭包的体现。
test方法中定义了一个数组arr，通过for循环依次将arr的0到9共十个位置依次填入function。可填入的方法根本没有被执行，输出的i没有变动，所以myArr数组中存储的只是十个一样的function。
而当使用for循环依次输出时，这时才真正执行了数组中的function，此时test中的i由于循环结束，最后i的值为10（由于闭包，与test的ao的关系并没有销毁），所以最后输出的结果是十个"10"。

如果说我就是想输出0到9十个数呢，这里就要引出一个新概念，叫立即执行函数。


立即执行函数
定义：此类没有声明，在执行过后就释放，适合做初始化工作的函数，叫立即执行函数。
它的推荐形式：
(function(形参){
    代码
})(实参);

这样通过立即执行函数，就可以解决上述问题。
```
    function test(){
        var arr = [];
        for(var i = 0 ; i < 10 ; i++){

            (function (j){
                
                arr[j] = function () {
                    document.write(j + "  ")
                }
            }(i));
        }
        return arr;
    }

    var myArr = test();
    for(var j = 0 ; j < 10 ; j++){
        myArr[j]();
    }
```

如果将for循环内部改写成立即执行函数的话，每次循环，函数内部都会被执行，这时arr函数内部存储的j就不是固定的了，而是i传进来的值，也就是0到9。for循环执行十次，也就是说执行了十次立即执行函数，创建了十次ao，这十个ao分别存储了j的值。到了使用for循环执行myArr数组内部的function时，将十个立即执行函数的ao中的j的值输出。
所以最终的结果是0到9依次输出。

总而言之，立即执行函数会形成一个单独的作用域，我们可以封装一些临时变量或者局部变量，避免污染全局变量。